#!/bin/bash

. "$( dirname "${BASH_SOURCE[0]}" )"/nvst

name="`basename "$0"`"

env="${NVST_ENV:-development}"
port="${NVST_PORT:-8080}"
pidfile="$NVST_ROOT/tmp/pids/unicorn.pid"

running() {
  [ -f "$pidfile" ] && kill -s 0 `cat "$pidfile"` 2>&1
}

start() {
  bundle exec unicorn -c "$NVST_ROOT/config/unicorn.rb" -E "$env" -l "$port" -D
}

case "$1" in
  start)
    if ! running; then
      start
    else
      echo "$name: already running" >&2
    fi
  ;;
  restart)
    if ! running; then
      start
    else
      kill -s USR2 "`cat "$pidfile"`"
    fi
  ;;
  stop)
    if ! running; then
      echo "$name: not running" >&2
    else
      kill -s QUIT "`cat "$pidfile"`"
    fi
  ;;
  *)
    echo $"Usage: "$name" {start|stop|restart}"
esac
